<!doctypehtml><html lang=zh-CN><meta charset=UTF-8><meta content=width=device-width name=viewport><meta media="(prefers-color-scheme: light)" content=#222 name=theme-color><meta media="(prefers-color-scheme: dark)" content=#222 name=theme-color><meta content="Hexo 7.0.0" name=generator><link href=/images/apple-touch-icon-next.png rel=apple-touch-icon sizes=180x180><link href=/uploads/favicon.png rel=icon sizes=32x32 type=image/png><link href=/uploads/favicon.png rel=icon sizes=16x16 type=image/png><link color=#222 href=/images/logo.svg rel=mask-icon><meta content=OjZus6o2Mdpe6amcrVvFu7aVReMoe-zG4QnNHK_pRqU name=google-site-verification><link href=/css/main.css rel=stylesheet><link crossorigin=anonymous href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css integrity=sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o= rel=stylesheet><link crossorigin=anonymous href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css integrity=sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE= rel=stylesheet><link crossorigin=anonymous href=https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.css integrity=sha256-6cQIC71/iBIYXFK+0RHAvwmjwWzkWd+r7v/BX3/vZDc= rel=stylesheet><link href=https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/green/pace-theme-minimal.css rel=stylesheet><script crossorigin=anonymous integrity=sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0= src=https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js></script><script class=next-config data-name=main type=application/json>{"hostname":"www.430074.xyz","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.19.1","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"default"},"fold":{"enable":true,"height":200},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src=/js/config.js></script><meta content="GRE 隧道为 BT 下载伪装地址一、前言总所周知，Buyvm 服务器优点有：带宽大（10Gb/s），不限流量，卢森堡抗 DMCA，无限 ipv6，可挂载存储块。但是 Buyvm 缺点为存储块 IO 较低且价格较高。buyvm 做 BT 下载器每月至少 3.5 刀服务器 + 1.5 刀存储块还是太贵了。同时我还有一台大带宽、大硬盘、高 IO 但是不抗 DMCA 的 online 服务器。 这里我们" name=description><meta content=blog property=og:type><meta content="GRE 隧道为 BT 下载伪装地址" property=og:title><meta content=https://www.430074.xyz/posts/gre_aria2.html property=og:url><meta content="Jarmo's Blog" property=og:site_name><meta content="GRE 隧道为 BT 下载伪装地址一、前言总所周知，Buyvm 服务器优点有：带宽大（10Gb/s），不限流量，卢森堡抗 DMCA，无限 ipv6，可挂载存储块。但是 Buyvm 缺点为存储块 IO 较低且价格较高。buyvm 做 BT 下载器每月至少 3.5 刀服务器 + 1.5 刀存储块还是太贵了。同时我还有一台大带宽、大硬盘、高 IO 但是不抗 DMCA 的 online 服务器。 这里我们" property=og:description><meta content=zh_CN property=og:locale><meta content=https://z1.ax1x.com/2023/12/12/piWTYPx.png property=og:image><meta content=2023-12-16T16:34:09.000Z property=article:published_time><meta content=2023-12-16T16:57:55.720Z property=article:modified_time><meta content="Jarmo Hu" property=article:author><meta content=编程 property=article:tag><meta content=网络 property=article:tag><meta content=建站 property=article:tag><meta content=summary name=twitter:card><meta content=https://z1.ax1x.com/2023/12/12/piWTYPx.png name=twitter:image><link href=https://www.430074.xyz/posts/gre_aria2.html rel=canonical><script class=next-config data-name=page type=application/json>{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.430074.xyz/posts/gre_aria2.html","path":"/posts/gre_aria2.html","title":"GRE 隧道为 BT 下载伪装地址"}</script><script class=next-config data-name=calendar type=application/json>""</script><title>GRE 隧道为 BT 下载伪装地址 | Jarmo's Blog</title><noscript><link href=/css/noscript.css rel=stylesheet></noscript><link title="Jarmo's Blog" href=/atom.xml rel=alternate type=application/atom+xml><body class=use-motion itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><div class=column><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=site-brand-container><div class=site-nav-toggle><div aria-label=切换导航栏 class=toggle role=button><span class=toggle-line></span><span class=toggle-line></span><span class=toggle-line></span></div></div><div class=site-meta><a class=brand href=/ rel=start> <i class=logo-line></i> <p class=site-title>Jarmo's Blog</p> <i class=logo-line></i> </a><p class=site-subtitle itemprop=description>人生总要做点什么吧</div><div class=site-nav-right><div class="toggle popup-trigger" aria-label=搜索 role=button><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ rel=section><i class="fa fa-home fa-fw"></i>首页</a><li class="menu-item menu-item-about"><a href=/about/ rel=section><i class="fa fa-user fa-fw"></i>关于</a><li class="menu-item menu-item-tags"><a href=/tags/ rel=section><i class="fa fa-tags fa-fw"></i>标签<span class=badge>9</span></a><li class="menu-item menu-item-categories"><a href=/categories/ rel=section><i class="fa fa-th fa-fw"></i>分类<span class=badge>7</span></a><li class="menu-item menu-item-archives"><a href=/archives/ rel=section><i class="fa fa-archive fa-fw"></i>归档<span class=badge>9</span></a><li class="menu-item menu-item-sitemap"><a href=/sitemap.xml rel=section><i class="fa fa-sitemap fa-fw"></i>站点地图</a><li class="menu-item menu-item-search"><a class=popup-trigger role=button><i class="fa fa-search fa-fw"></i>搜索 </a></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon> <i class="fa fa-search"></i> </span><div class=search-input-container><input autocapitalize=off autocomplete=off class=search-input maxlength=80 placeholder=搜索... spellcheck=false type=search></div><span class=popup-btn-close role=button> <i class="fa fa-times-circle"></i> </span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录<li class=sidebar-nav-overview>站点概览</ul><div class=sidebar-panel-container><!--noindex--><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class=nav><li class="nav-item nav-level-1"><a class=nav-link href=#GRE%E9%9A%A7%E9%81%93%E4%B8%BABT%E4%B8%8B%E8%BD%BD%E4%BC%AA%E8%A3%85%E5%9C%B0%E5%9D%80><span class=nav-number>1.</span> <span class=nav-text>GRE 隧道为 BT 下载伪装地址</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#%E4%B8%80%E3%80%81%E5%89%8D%E8%A8%80><span class=nav-number>1.1.</span> <span class=nav-text>一、前言</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E4%BA%8C%E3%80%81%E6%95%99%E7%A8%8B><span class=nav-number>1.2.</span> <span class=nav-text>二、教程</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#2-1-%E5%AE%89%E8%A3%85aria2><span class=nav-number>1.2.1.</span> <span class=nav-text>2.1 安装 aria2</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#2-2-%E6%90%AD%E5%BB%BAGRE%E9%9A%A7%E9%81%93><span class=nav-number>1.2.2.</span> <span class=nav-text>2.2 搭建 GRE 隧道</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#2-3-%E4%B8%AD%E8%BD%AC%E6%9C%BA%E5%AE%9E%E7%8E%B0%E8%B7%AF%E7%94%B1%E5%8A%9F%E8%83%BD><span class=nav-number>1.2.3.</span> <span class=nav-text>2.3 中转机实现路由功能</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#2-4-aria2%E8%AE%BE%E7%BD%AE><span class=nav-number>1.2.4.</span> <span class=nav-text>2.4 aria2 设置</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#%E4%B8%89%E3%80%81%E7%BB%93%E6%9E%9C%E5%B1%95%E7%A4%BA><span class=nav-number>1.3.</span> <span class=nav-text>三、结果展示</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E5%9B%9B%E3%80%81%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98><span class=nav-number>1.4.</span> <span class=nav-text>四、相关问题</span></a></ol></ol></div></div><!--/noindex--><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop=author itemscope itemtype=http://schema.org/Person><p class=site-author-name itemprop=name>Jarmo Hu<div class=site-description itemprop=description>意义是自己赋予的</div></div><div class="site-state-wrap animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/> <span class=site-state-item-count>9</span> <span class=site-state-item-name>日志</span> </a></div><div class="site-state-item site-state-categories"><a href=/categories/> <span class=site-state-item-count>7</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/> <span class=site-state-item-count>9</span> <span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-author animated"><span class=links-of-author-item> <span title="GitHub → https://github.com/jarmohu" class=exturl data-url=aHR0cHM6Ly9naXRodWIuY29tL2phcm1vaHU=><i class="fab fa-github fa-fw"></i>GitHub</span> </span><span class=links-of-author-item> <span title="E-Mail → mailto:jarmohu@qq.com" class=exturl data-url=bWFpbHRvOmphcm1vaHVAcXEuY29t><i class="fa fa-envelope fa-fw"></i>E-Mail</span> </span></div><div class="cc-license animated" itemprop=license><span class="exturl cc-opacity" data-url=aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo><img alt="Creative Commons" src=https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article lang=zh-CN><link href=https://www.430074.xyz/posts/gre_aria2.html itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/images/avatar.gif itemprop=image> <meta content="Jarmo Hu" itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content="Jarmo's Blog" itemprop=name> <meta content=意义是自己赋予的 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="GRE 隧道为 BT 下载伪装地址 | Jarmo's Blog" itemprop=name> <meta itemprop=description> </span><header class=post-header><h1 itemprop="name headline" class=post-title>GRE 隧道为 BT 下载伪装地址</h1><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2023-12-17 00:34:09 / 修改时间：00:57:55" datetime=2023-12-17T00:34:09+08:00>2023-12-17</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/%E7%BC%96%E7%A8%8B%EF%BC%8C%E5%BB%BA%E7%AB%99/ itemprop=url rel=index><span itemprop=name>编程，建站</span></a> </span> </span><span class=post-meta-item id=busuanzi_container_page_pv title=阅读次数> <span class=post-meta-item-icon> <i class="far fa-eye"></i> </span> <span class=post-meta-item-text>阅读次数：</span> <span id=busuanzi_value_page_pv></span> </span><span class=post-meta-break></span><span class=post-meta-item title=本文字数> <span class=post-meta-item-icon> <i class="far fa-file-word"></i> </span> <span class=post-meta-item-text>本文字数：</span> <span>2k</span> </span><span class=post-meta-item title=阅读时长> <span class=post-meta-item-icon> <i class="far fa-clock"></i> </span> <span class=post-meta-item-text>阅读时长 ≈</span> <span>7 分钟</span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=GRE隧道为BT下载伪装地址><a class=headerlink href=#GRE隧道为BT下载伪装地址 title=GRE隧道为BT下载伪装地址></a>GRE 隧道为 BT 下载伪装地址</h1><h2 id=一、前言><a class=headerlink href=#一、前言 title=一、前言></a>一、前言</h2><p>总所周知，Buyvm 服务器优点有：<strong>带宽大（10Gb/s），不限流量，卢森堡抗 DMCA，无限 ipv6，可挂载存储块</strong>。但是 Buyvm 缺点为<strong>存储块 IO 较低且价格较高</strong>。buyvm 做 BT 下载器每月至少 3.5 刀服务器 + 1.5 刀存储块还是太贵了。同时我还有一台大带宽、大硬盘、高 IO 但是不抗 DMCA 的 online 服务器。<p>这里我们将 buyvm 当作 online 服务器的下载网关，中转下载 BT，从而实现 online 下载但是抗 DMCA 的效果。同时我们还提出了多台 online 下载服务器共用一台 buyvm 网关，共平摊 3.5 刀成本，共享 10G 带宽。</p><span id=more></span><p>该方案为 online 上搭建 aria2 服务器，online 和 buyvm 通过 GRE 隧道链接。在下载时，外网看到的下载服务器 ip 是 buyvm 的 ip，从而实现了抗 DMCA。多个服务器共享时，每台服务分配 ipv4 的不同端口，和一个独立的 IPV6。<p>相较于 wireguard 方案，本方案好处是对性能的要求大大降低，可同时支持多台服务器。本方案的第二个优点是，通过对 linux 五表四链的详细研究，online 服务器无需全局转发，只需转发 aria2 流量即可。本方案的缺点是，GRE 隧道无加密，但是大部分人的 TCP 和 UDP 都在 TLS 层或者应用层进行了加密，所谓无需担心。本方案第二个缺点是，需要用户对 linux 的网络配置有一定的了解，我后面会专门讲一下怎么配置。<p>是的，我写这篇文章的目的就是为了宣传一下，希望大家提提建议，或者有需要的话加入我。<h2 id=二、教程><a class=headerlink href=#二、教程 title=二、教程></a>二、教程</h2><h3 id=2-1-安装aria2><a title="2.1 安装aria2" class=headerlink href=#2-1-安装aria2></a>2.1 安装 aria2</h3><p>你们可以自行安装，也可以通过如下脚本：<pre class="line-numbers language-bash" data-language=bash><code class=language-bash><span class="token function">wget</span> <span class="token parameter variable">-N</span> <span class="token string">"https://raw.githubusercontent.com/JarmoHu/aria2.sh/master/aria2.sh"</span> <span class="token operator">&&</span> <span class="token function">chmod</span> +x aria2.sh <span class="token operator">&&</span> ./aria2.sh<span aria-hidden=true class=line-numbers-rows><span></span></span></code></pre><p>该脚本基于 P3terx 大佬的脚本修改，主要是大佬好像一直不更新了，我就改了改下载源。<h3 id=2-2-搭建GRE隧道><a title="2.2 搭建GRE隧道" class=headerlink href=#2-2-搭建GRE隧道></a>2.2 搭建 GRE 隧道</h3><p>这里假设，中转机（如 BUYVM）的 IP 为：<code>1.1.1.1</code> 和 <code>1111::</code>，下载机（如 IP 的）的 IP 为：<code>2.2.2.2</code> 和 <code>2222::</code>。<br>其中 BUYVM 添加 IPV6 的方式网上有很多了，可以自己去搜索一下。<p>下载机运行如下脚本：<pre class="line-numbers language-bash" data-language=bash><code class=language-bash><span class="token comment"># 这里是添加GRE隧道叫bt，并且添加隧道内网IPV4和IPV6</span>
<span class="token function">ip</span> tunnel <span class="token function">add</span> bt mode gre <span class="token builtin class-name">local</span> <span class="token number">2.2</span>.2.2 remote <span class="token number">1.1</span>.1.1 ttl <span class="token number">255</span>
<span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">192.168</span>.100.2/30 peer <span class="token number">192.168</span>.100.1 dev bt
<span class="token function">ip</span> <span class="token parameter variable">-6</span> addr <span class="token function">add</span> FEC0::1000:2/124 peer FEC0::1000:1 dev bt
<span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> bt up
<span class="token function">sleep</span> <span class="token number">3</span>

<span class="token comment"># 这里是新建一个路由表（编号2）</span>
<span class="token function">ip</span> route <span class="token function">add</span> default via <span class="token number">192.168</span>.100.1 dev bt table <span class="token number">2</span> src <span class="token number">192.168</span>.100.2
<span class="token function">ip</span> <span class="token parameter variable">-6</span> route <span class="token function">add</span> default via FEC0::1000:1 dev bt table <span class="token number">2</span> src FEC0::1000:2

<span class="token comment"># 新建路由规则，即隧道IP走上面新建的路由表2</span>
<span class="token function">ip</span> rule <span class="token function">add</span> from <span class="token number">192.168</span>.100.0/30 table <span class="token number">2</span>
<span class="token function">ip</span> <span class="token parameter variable">-6</span> rule <span class="token function">add</span> from FEC0::1000:0/124 table <span class="token number">2</span>

<span class="token comment"># 添加默认路由指向隧道对端</span>
<span class="token function">ip</span> <span class="token parameter variable">-6</span> route <span class="token function">add</span> fec0::1000:1 dev bt proto kernel metric <span class="token number">256</span> pref medium
<span class="token function">sleep</span> <span class="token number">3</span>

<span class="token comment"># 刷新内核参数</span>
<span class="token function">sysctl</span> <span class="token parameter variable">-p</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>中转机运行如下脚本：<pre class="line-numbers language-bash" data-language=bash><code class=language-bash><span class="token comment"># 这里添加gre隧道叫bt</span>
<span class="token function">ip</span> tunnel <span class="token function">add</span> bt mode gre <span class="token builtin class-name">local</span> <span class="token number">2.2</span>.2.2 remote <span class="token number">1.1</span>.1.1 ttl <span class="token number">255</span>
<span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">192.168</span>.100.1/30 peer <span class="token number">192.168</span>.100.2 dev bt
<span class="token function">ip</span> <span class="token parameter variable">-6</span> addr <span class="token function">add</span> FEC0::1000:1/124 peer FEC0::1000:2 dev bt
<span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> bt up
<span class="token function">sleep</span> <span class="token number">3</span>

<span class="token comment"># 这里将外部51000-52000端口DNAT转发到下载机。当外部IP访问中转机这些端口（如1.1.1.1:51000），实际访问的是下载机的内网IP（192.168.100.2:51000）</span>
iptables <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-A</span> PREROUTING <span class="token parameter variable">-d</span> <span class="token number">1.1</span>.1.1 <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-m</span> multiport <span class="token parameter variable">--dports</span> <span class="token number">51000</span>:52000 <span class="token parameter variable">-j</span> DNAT --to-destination <span class="token number">192.168</span>.100.2:51000:52000
iptables <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-A</span> PREROUTING <span class="token parameter variable">-d</span> <span class="token number">1.1</span>.1.1 <span class="token parameter variable">-p</span> udp <span class="token parameter variable">-m</span> multiport <span class="token parameter variable">--dports</span> <span class="token number">51000</span>:52000 <span class="token parameter variable">-j</span> DNAT --to-destination <span class="token number">192.168</span>.100.2:51000:52000
<span class="token comment"># 这里通过SNAT实现网关功能。即下载机发出的包，通过gre隧道来到中转机，此时中转机将源地址改为中转机的外部IP，实现IP伪装。</span>
iptables <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-A</span> POSTROUTING <span class="token parameter variable">-s</span> <span class="token number">192.168</span>.100.0/30 <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-j</span> SNAT --to-source <span class="token number">1.1</span>.1.1
iptables <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-A</span> POSTROUTING <span class="token parameter variable">-s</span> <span class="token number">192.168</span>.100.0/30 <span class="token parameter variable">-p</span> udp <span class="token parameter variable">-j</span> SNAT --to-source <span class="token number">1.1</span>.1.1

<span class="token comment"># 这里ipv6所有端口都进行转发，基本原理和上述IPV4一样</span>
ip6tables <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-A</span> PREROUTING <span class="token parameter variable">-d</span> <span class="token number">1111</span>:: <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-j</span> DNAT --to-destination FEC0::1000:2
ip6tables <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-A</span> PREROUTING <span class="token parameter variable">-d</span> <span class="token number">1111</span>:: <span class="token parameter variable">-p</span> udp <span class="token parameter variable">-j</span> DNAT --to-destination FEC0::1000:2
ip6tables <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-A</span> POSTROUTING <span class="token parameter variable">-s</span> FEC0::1000:0/124 <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-j</span> SNAT --to-source <span class="token number">1111</span>::
ip6tables <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-A</span> POSTROUTING <span class="token parameter variable">-s</span> FEC0::1000:0/124 <span class="token parameter variable">-p</span> udp <span class="token parameter variable">-j</span> SNAT --to-source <span class="token number">1111</span>::

<span class="token comment"># 添加默认路由</span>
<span class="token function">ip</span> <span class="token parameter variable">-6</span> route <span class="token function">add</span> fec0::1000:2 dev bt proto kernel metric <span class="token number">256</span> pref medium
<span class="token function">sleep</span> <span class="token number">3</span>

<span class="token comment"># 刷新内核参数</span>
<span class="token function">sysctl</span> <span class="token parameter variable">-p</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>搞完之后，可以在下载机里运行 <code>ping 192.168.100.1</code>，查看结果<pre class="line-numbers language-bash" data-language=bash><code class=language-bash><span class="token punctuation">(</span>base<span class="token punctuation">)</span> root@sd-160887:~<span class="token comment"># ping 192.168.100.1</span>
PING <span class="token number">192.168</span>.100.1 <span class="token punctuation">(</span><span class="token number">192.168</span>.100.1<span class="token punctuation">)</span> <span class="token number">56</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span> bytes of data.
<span class="token number">64</span> bytes from <span class="token number">192.168</span>.100.1: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">8.62</span> ms
<span class="token number">64</span> bytes from <span class="token number">192.168</span>.100.1: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">8.50</span> ms
<span class="token number">64</span> bytes from <span class="token number">192.168</span>.100.1: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">8.39</span> ms<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id=2-3-中转机实现路由功能><a title="2.3 中转机实现路由功能" class=headerlink href=#2-3-中转机实现路由功能></a>2.3 中转机实现路由功能</h3><p>这里需要对中转机的内核参数进行一些修改，在 /etc/stsctl.conf 中添加运行转发的选项。<pre class="line-numbers language-conf" data-language=conf><code class=language-conf>net.ipv6.conf.all.disable_ipv6 = 0
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span></span></code></pre><p>然后通过和 ChatGPT 合理的交流，中转机可以进行如下优化。同样建议加在 /etc/stsctl.conf 后面。<pre class="line-numbers language-conf" data-language=conf><code class=language-conf>net.core.optmem_max = 25165824
net.core.netdev_max_backlog = 5000

net.core.wmem_default = 262144
net.core.rmem_default = 262144
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.core.somaxconn = 65535

net.ipv4.tcp_rmem=4096 87380 16777216
net.ipv4.tcp_wmem=4096 65536 16777216
# net.ipv6.tcp_rmem = 4096 87380 33554432
# net.ipv6.tcp_wmem = 4096 65536 33554432

net.ipv4.route.max_size = 16384
net.ipv6.route.max_size = 16384

net.ipv4.tcp_fastopen = 3

net.ipv4.ip_local_port_range = 10240 65535

net.ipv4.tcp_tw_reuse = 0
net.ipv4.tcp_fin_timeout = 10
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_keepalive_time = 300
net.ipv4.tcp_keepalive_probes = 5
net.ipv4.tcp_keepalive_intvl = 15

fs.file-max = 65536
net.ipv4.conf.all.rp_filter = 0
net.ipv4.conf.default.rp_filter = 0<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改完后建议运行 <code>sysctl -p</code> 加载内核参数。<h3 id=2-4-aria2设置><a title="2.4 aria2设置" class=headerlink href=#2-4-aria2设置></a>2.4 aria2 设置</h3><p>如果你是用的我上面的脚本，设置文件路径为<code>./.arai2c/aria2.conf</code>。这里说几个很关键的设置。<pre class="line-numbers language-conf" data-language=conf><code class=language-conf># 这里写上面新建的gre隧道，叫bt。我不知道为什么，当我设置为特定IP的时候(如第二行)，aria2会出现不稳定的情况。
multiple-interface=bt
#multiple-interface=192.168.100.2,FEC0::1000:2

# 这里填写中转机的外部IP
bt-external-ip=1.1.1.1, 1111::

# 这是rpc的链接端口，需要填写成ipv4分配给这台下载机的端口中一个，即上述51000-52000
rpc-listen-port=51000

# BT下载端口，也是要填写分配给你的端口中的一个51000-52000
listen-port=51001

# DHT端口，建议和BT端口一样
dht-listen-port=51001

# 异步DNS，不知道为什么，反正配置之后更加稳定。注意第二行的server也要配置。1.1.1.1这里指的不是中转机IP，就是CF的DNS节点，无需修改。
async-dns=true
async-dns-server=8.8.8.8, 1.1.1.1<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id=三、结果展示><a class=headerlink href=#三、结果展示 title=三、结果展示></a>三、结果展示</h2><p>通过 aria2 下载 ubuntu.iso 的过程如下，下载的速度达到了 700Mb/s，但是 buyvm 的 CPU 占用不到 2%，明显是支持多人使用的。<br><img alt=image data-src=https://z1.ax1x.com/2023/12/12/piWTYPx.png><h2 id=四、相关问题><a class=headerlink href=#四、相关问题 title=四、相关问题></a>四、相关问题</h2><ol><li><strong>为什么不用 socks5 或者 wireguard 代理，一定要使用 GRE？</strong><br>因为 GRE 性能占用几乎为 0。我想实现多人共用一台 BUYVM，毕竟一个月 3.5 刀也不便宜了，要是为了下载 BT，不如直接冲 115 会员。至于你说我抠，emmmmm。确实是有一点吧，毕竟咱是学生啊。<li><strong>搭建一个 http 服务器，然后用 QB 只代理 trackers 连接行不行？</strong><br>我认为是不行的，只能骗过一些 PT 站，但是<strong>他们想要查还是查得到的</strong>。比如版权商在 Tracker 上登记了一个下载客户端地址，你这边获取到了这个 peer 地址，然后通过自己的客户端连接也是会暴露你的真实 ip 的。或者 DHT 交换也能把你的真实地址暴露。同时，如果你登记 Tracker 的是一个错误的地址，其他人无法主动连接你，只能你去连接其他人，如果对方开了防火墙就无法连接了。BT 比较吃保种人数，所以会影响下载速度。<li><strong>除了下载 BT 还有别的玩法吗？</strong><br>我觉得既然 IPV6 给了你了，你可以试试建站。同时 IPV4 以后建站也可使试试 haproxy 端口复用转发后端。至于你要建什么站，emmmmm，buyvm 反正访问速度慢，应该不是面向大陆。</ol></div><footer class=post-footer><div class=post-copyright><ul><li class=post-copyright-author><strong>本文作者： </strong>Jarmo Hu<li class=post-copyright-link><strong>本文链接：</strong> <a title="GRE 隧道为 BT 下载伪装地址" href=https://www.430074.xyz/posts/gre_aria2.html>https://www.430074.xyz/posts/gre_aria2.html</a><li class=post-copyright-license><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <span class=exturl data-url=aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> 许可协议。转载请注明出处！</ul></div><div class=followme><span>欢迎关注我的其它发布渠道</span><div class=social-list><div class=social-item><a class=social-link href=/atom.xml target=_blank> <span class=icon> <i class="fa fa-rss"></i> </span> <span class=label>RSS</span> </a></div></div></div><div class=post-tags><a href=/tags/%E7%BC%96%E7%A8%8B/ rel=tag><i class="fa fa-tag"></i> 编程</a><a href=/tags/%E7%BD%91%E7%BB%9C/ rel=tag><i class="fa fa-tag"></i> 网络</a><a href=/tags/%E5%BB%BA%E7%AB%99/ rel=tag><i class="fa fa-tag"></i> 建站</a></div><div class=post-nav><div class=post-nav-item><a title="Hello World" href=/posts/hello-world.html rel=prev> <i class="fa fa-angle-left"></i> Hello World </a></div><div class=post-nav-item></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=beian><span class=exturl data-url=aHR0cHM6Ly9iZWlhbi5taWl0Lmdvdi5jbg==>鄂ICP备 20002600号-2 </span><img alt src=https://beian.mps.gov.cn/favicon.ico><span class=exturl data-url=aHR0cHM6Ly9iZWlhbi5tcHMuZ292LmNuLyMvcXVlcnkvd2ViU2VhcmNoP2NvZGU9NDIwMTExMDIwMDU0MDk=>鄂公网安备 42011102005409号 </span></div><div class=copyright>© <span itemprop=copyrightYear>2023</span><span class=with-love> <i class="fa fa-heart"></i> </span><span class=author itemprop=copyrightHolder>Jarmo Hu</span></div><div class=wordcount><span class=post-meta-item> <span class=post-meta-item-icon> <i class="fa fa-chart-line"></i> </span> <span title=站点总字数>8k</span> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="fa fa-coffee"></i> </span> <span title=站点阅读时长>28 分钟</span> </span></div><div class=busuanzi-count><span class=post-meta-item id=busuanzi_container_site_uv> <span class=post-meta-item-icon> <i class="fa fa-user"></i> </span> <span class=site-uv title=总访客量> <span id=busuanzi_value_site_uv></span> </span> </span><span class=post-meta-item id=busuanzi_container_site_pv> <span class=post-meta-item-icon> <i class="fa fa-eye"></i> </span> <span class=site-pv title=总访问量> <span id=busuanzi_value_site_pv></span> </span> </span></div><div class=powered-by>由 <span class=exturl data-url=aHR0cHM6Ly9oZXhvLmlv>Hexo</span> & <span class=exturl data-url=aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZw==>NexT.Gemini</span> 强力驱动</div></div></footer><div aria-label=返回顶部 class=back-to-top role=button><i class="fa fa-arrow-up fa-lg"></i><span>0%</span></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><script alpha=0.6 size=300 src=https://cdnjs.cloudflare.com/ajax/libs/ribbon.js/1.0.2/ribbon.min.js zindex=-1></script><script crossorigin=anonymous integrity=sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY= src=https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js></script><script crossorigin=anonymous integrity=sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao= src=https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js></script><script crossorigin=anonymous integrity=sha256-ytMJGN3toR+a84u7g7NuHm91VIR06Q41kMWDr2pq7Zo= src=https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.umd.js></script><script crossorigin=anonymous integrity=sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc= src=https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js></script><script crossorigin=anonymous integrity=sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I= src=https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js></script><script src=/js/comments.js></script><script src=/js/utils.js></script><script src=/js/motion.js></script><script src=/js/next-boot.js></script><script src=/js/pjax.js></script><script crossorigin=anonymous integrity=sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc= src=https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js></script><script src=/js/third-party/search/local-search.js></script><script src=/js/third-party/fancybox.js></script><script src=/js/third-party/pace.js></script><script async data-pjax src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><script class=next-config data-name=enableMath type=application/json>false</script><script class=next-config data-name=mathjax type=application/json>{"enable":true,"tags":"all","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src=/js/third-party/math/mathjax.js></script>